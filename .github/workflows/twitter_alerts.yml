name: Twitter Line Movement Alerts

on:
  # Run after odds feed updates
  workflow_run:
    workflows: ["Update Odds Feed"]
    types:
      - completed
  # Allow manual triggers
  workflow_dispatch:
    inputs:
      recap_only:
        description: 'Post daily recap only'
        required: false
        default: 'false'
        type: boolean
      dry_run:
        description: 'Dry run (no actual tweets)'
        required: false
        default: 'false'
        type: boolean
      test_tweet:
        description: 'Post a test tweet'
        required: false
        default: 'false'
        type: boolean

jobs:
  post-alerts:
    runs-on: ubuntu-latest
    # Only run if odds feed succeeded (or manual trigger)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Get latest commit (odds feed may have just pushed)
          ref: main

      - name: Pull latest changes
        run: git pull origin main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Twitter alerts
        env:
          TWITTER_CLIENT_ID: ${{ secrets.TWITTER_CLIENT_ID }}
          TWITTER_CLIENT_SECRET: ${{ secrets.TWITTER_CLIENT_SECRET }}
          TWITTER_REFRESH_TOKEN: ${{ secrets.TWITTER_REFRESH_TOKEN }}
        run: |
          ARGS=""
          if [ "${{ github.event.inputs.test_tweet }}" == "true" ]; then
            ARGS="--test"
          else
            if [ "${{ github.event.inputs.recap_only }}" == "true" ]; then
              ARGS="$ARGS --recap"
            fi
            if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
              ARGS="$ARGS --dry-run"
            fi
          fi
          python -m ante_ai.twitter_bot $ARGS
